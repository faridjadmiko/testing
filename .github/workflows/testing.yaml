name: Telegram Notify Only

on:
  push:
    branches:
      - main

jobs:
  send-telegram:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: test-image
      TAG: latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          ESCAPE() {
            echo "$1" | sed -e 's/\\/\\\\/g' \
                            -e 's/\./\\./g' \
                            -e 's/\*/\\*/g' \
                            -e 's/_/\\_/g' \
                            -e 's/`/\\`/g' \
                            -e 's/\[/\\[/g' \
                            -e 's/\]/\\]/g' \
                            -e 's/(/\\(/g' \
                            -e 's/)/\\)/g' \
                            -e 's/~ /\\~/g' \
                            -e 's/>/\\>/g' \
                            -e 's/#/\\#/g' \
                            -e 's/\+/\\+/g' \
                            -e 's/-/\\-/g' \
                            -e 's/=/\\=/g' \
                            -e 's/!/\\!/g' \
                            -e 's/{/\\{/g' \
                            -e 's/}/\\}/g' \
                            -e 's/|/\\|/g'
          }

          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          IMAGE_NAME="${{ env.IMAGE_NAME }}"
          TAG="${{ env.TAG }}"

          ESCAPED_COMMIT_MESSAGE=$(ESCAPE "$COMMIT_MESSAGE")
          ESCAPED_COMMIT_AUTHOR=$(ESCAPE "$COMMIT_AUTHOR")
          ESCAPED_IMAGE_NAME=$(ESCAPE "$IMAGE_NAME")
          ESCAPED_TAG=$(ESCAPE "$TAG")

          MESSAGE="‚úÖ Image \`${ESCAPED_IMAGE_NAME}:${ESCAPED_TAG}\` pushed to SWR.\n\nüìù Commit: *${ESCAPED_COMMIT_MESSAGE}*\nüë§ Author: *${ESCAPED_COMMIT_AUTHOR}*"

          curl -s -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode=MarkdownV2

